import java.io.IOException;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Timer;
import java.util.TimerTask;

import java.text.SimpleDateFormat;
import java.util.Date;

import java.net.*;
import java.io.*;

public class CreateChiMonitor {
    // socket for connection to SISServer
    static Socket universal;
    private static int port = 53217;
    // message writer
    static MsgEncoder encoder;
    // message reader
    static MsgDecoder decoder;

    // scope of this component
    private static final String SCOPE = "SIS.Chi";
    // name of this component
    private static final String NAME = "ChiMonitor";//Liang

    // messages types that can be handled by this component
    // TODO: define your message here
    private static final List<String> TYPES= new ArrayList<String>(
			Arrays.asList(new String[] { "Setting", "Confirm","Reading" }));

    private static int refreshRate = 500, max, min = 90;
    private static Date startDate = new Date(), endDate = new Date();

    private static Timer timer = new Timer();

    // shared by all kinds of records that can be generated by this component
    private static KeyValueList record = new KeyValueList();
    // shared by all kinds of alerts that can be generated by this component
    private static KeyValueList alert = new KeyValueList();

    private static MonitorReading reading = new MonitorReading();

    /*
     * Main program
     */
    public static void main(String[] args) {
        while (true) {
            try {
                // try to establish a connection to SISServer
                universal = connect();

                // bind the message reader to inputstream of the socket
                decoder = new MsgDecoder(universal.getInputStream());
                // bind the message writer to outputstream of the socket
                encoder = new MsgEncoder(universal.getOutputStream());

                /*
                 * construct a Connect message to establish the connection
                 */
                KeyValueList conn = new KeyValueList();
                conn.putPair("Scope", SCOPE);
                conn.putPair("MessageType", "Connect");
                conn.putPair("Role", "Basic");
                conn.putPair("Name", NAME);
                encoder.sendMsg(conn);

                initRecord();

                // KeyValueList for inward messages, see KeyValueList for
                // details
                KeyValueList kvList;

                while (true) {
                    // attempt to read and decode a message, see MsgDecoder for
                    // details
                    kvList = decoder.getMsg();
                    // process that message
					ProcessMsg(kvList);
                }

            } catch (Exception e) {
                // if anything goes wrong, try to re-establish the connection
                try {
                    // wait for 1 second to retry
                    Thread.sleep(1000);
                } catch (InterruptedException e2) {
                }
                System.out.println("Try to reconnect");
                try {
                    universal = connect();
                } catch (IOException e1) {
                }
            }
        }
    }

    /*
     * used for connect(reconnect) to SISServer
     */
    static Socket connect() throws IOException {
        Socket socket = new Socket("127.0.0.1", port);
        return socket;
    }

    private static void initRecord() {
        record.putPair("Scope", SCOPE);
        record.putPair("MessageType", "Reading");
        record.putPair("Sender", NAME);

        // Receiver may be different for each message, so it doesn't make sense
        // to set here
        // record.putPair("Receiver", "");

        alert.putPair("Scope", SCOPE);
        alert.putPair("MessageType", "Alert");
        alert.putPair("Sender", NAME);
		alert.putPair("Purpose", "chiAlert");//Liang
        // Receiver may be different for each message, so it doesn't make sense
        // to set here
        // alert.putPair("Receiver", "");
    }
    private static void componentTask() {
        try {

            // TODO: create your component task here
			computeChiTotal();
			uploadChiTotal();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static void ProcessMsg(KeyValueList kvList) throws Exception {


		String scope = kvList.getValue("Scope");
		//System.out.println("scope--"+scope);//Liang
		//System.out.println("SCOPE--"+SCOPE);//Liang
        if (!SCOPE.startsWith(scope)) {
            return;
        }

        String messageType = kvList.getValue("MessageType");
		//System.out.println("messageType--"+messageType);//Liang
		//System.out.println("TYPES--"+TYPES);//Liang
        if (!TYPES.contains(messageType)) {
            return;
        }

        String sender = kvList.getValue("Sender");
		//System.out.println("sender--"+sender);//Liang

        String receiver = kvList.getValue("Receiver");
		//System.out.println("receiver--"+receiver);//Liang

        String purpose = kvList.getValue("Purpose");
		//System.out.println("purpose--"+purpose);//Liang

		// TODO: create the logic according to different messge type
        switch (messageType) {
            case "Confirm":
                System.out.println("Connect to SISServer successful.");
                break;
			case "Reading"://Liang	According chiSensor's send message
				
				//get uid and 5 Chi value from message	
				reading.uid=Integer.parseInt(kvList.getValue("Uid"));
				System.out.println("Uid:"+reading.uid);
				reading.VT=Integer.parseInt(kvList.getValue("Tongue"));			
				reading.VF=Integer.parseInt(kvList.getValue("Fatigue"));		
				reading.VW=Integer.parseInt(kvList.getValue("WeakBreadth"));	
				reading.VP=Integer.parseInt(kvList.getValue("Pulse"));			
				reading.VS=Integer.parseInt(kvList.getValue("Sweaty"));
				reading.V=kvList.getValue("chiTotal");
				reading.Originator=kvList.getValue("Originator");
				reading.mDate=Long.parseLong(kvList.getValue("Date"));
				//System.out.println(reading.mDate+"      **********");

				componentTask();
/*
                            timer.schedule(new TimerTask() {

                                @Override
                                public void run() {
                                    // Auto-generated method stub
                                    if (System.currentTimeMillis() - endDate.getTime() > 0) {
                                        cancel();
                                    } else {
                                        componentTask();
                                    }
                                }
                            }, startDate, refreshRate);
*/
                break;
			case "Setting":
                if (receiver.equals(NAME)) {

                    System.out.println("Message from " + sender);
					System.out.println("Message Receiver: " + receiver);
					System.out.println("Message type: " + messageType);
                    System.out.println("Message Purpose: " + purpose);

                    switch (purpose) {

						case "Activate":
                            // TODO: put your logic code here after the activation

							System.out.println("Algorithm Activated");
                            break;
                        // TODO: optionally, you can define your message here

                        case "Kill":
                            try {
                                timer.cancel();
                            } catch (Exception e) {
                                // TODO: handle exception
                            }
                            System.exit(0);
                            break;
                        // case "Activate":
                        // try {
                        // timer.cancel();
                        // timer = new Timer();
                        // } catch (Exception e) {
                        // // TODO: handle exception
                        // }
                        // timer.schedule(new TimerTask() {
                        //
                        // @Override
                        // public void run() {
                        // // TODO Auto-generated method stub
                        // if (System.currentTimeMillis() - endDate.getTime() > 0) {
                        // cancel();
                        // } else {
                        // componentTask();
                        // }
                        // }
                        // }, startDate, refreshRate);
                        // System.out.println("Algorithm Activated");
                        // break;
                        // case "Deactivate":
                        //     try {
                        //         timer.cancel();
                        //     } catch (Exception e) {
                        //         // TODO: handle exception
                        //     }
                        //     System.out.println("Algorithm Deactivated");
                        //     break;
                    }
                }
                break;
        }
    }
	//x
	private static void computeChiTotal(){
        try {
			//define Dia Sys SPO2 sex and age
			int Dia,RegularDia;
			int Sys,RegularSys;
			int SPO2;
			String sex;
			int age;
			//init
			Dia=-1;
			Sys=-1;
			SPO2=-1;
			RegularDia=0;
			RegularSys=0;
			age=-1;
			//According to user Email, I will get Bloodpresure(Dia and Sys) SPO2 from database and age sex from new table
/*
			//GET SPO2 from database
			String sqlstr="http://ksiresearchorg.ipage.com/chronobot/getRecords.php?q=Select%20*%20From%20records%20where%20DATEDIFF(NOW(),datetime)<7%20and%20type='spo2'%20and%20value%20>%200%20and%20uid='376896'%20%20order%20by%20rid%20desc%20limit%201";
			String querryResult;
			querryResult=download(sqlstr);//66591, 376896, 2016-03-08 15:53:27, SPO2, spo2, 98,
			if(querryResult.length()>0){
				//System.out.println(querryResult);
				//seperate spo2
				SPO2=getValue(querryResult);
				System.out.println("SPO2:"+getValue(querryResult));
			}else{
				SPO2=-1;
			}
			//GET Dia from database
			sqlstr="http://ksiresearchorg.ipage.com/chronobot/getRecords.php?q=Select%20*%20From%20records%20where%20DATEDIFF(NOW(),datetime)<7%20and%20type='diastolic'%20and%20value%20>%200%20and%20uid='376896'%20%20order%20by%20rid%20desc%20limit%201";
			querryResult=download(sqlstr);//66591, 376896, 2016-03-08 15:53:27, SPO2, spo2, 98,
			if(querryResult.length()>0){
				//System.out.println(querryResult);
				//seperate Dia
				Dia=getValue(querryResult);
				System.out.println("Dia:"+getValue(querryResult));
			}else{
				Dia=-1;
			}
			//GET Sys from database
			sqlstr="http://ksiresearchorg.ipage.com/chronobot/getRecords.php?q=Select%20*%20From%20records%20where%20DATEDIFF(NOW(),datetime)<7%20and%20type='systolic'%20and%20value%20>%200%20and%20uid='376896'%20%20order%20by%20rid%20desc%20limit%201";
			querryResult=download(sqlstr);//66591, 376896, 2016-03-08 15:53:27, SPO2, spo2, 98,
			if(querryResult.length()>0){
				//System.out.println(querryResult);
				//seperate Sys
				Sys=getValue(querryResult);
				System.out.println("Sys:"+getValue(querryResult));
			}else{
				Sys=-1;
			}
			//GET sex(gender) and birthday(compute age) from database
			sqlstr="http://ksiresearchorg.ipage.com/chronobot/getUsers.php?q=SELECT%20*%20FROM%20users%20WHERE%20uid=376896";
			querryResult=download(sqlstr);//376896, 150.212.71.54, al2105be, shikuochang@yahoo.com, Shikuo, Chang, s, m, 1973-02-22 00:00:00
			if(querryResult.length()>0){
				System.out.println("sex:"+getSex(querryResult));
				sex=getSex(querryResult);
				//x
				SimpleDateFormat sdf = new SimpleDateFormat("yyyy");
				Date date = new Date();
				String formatDate = sdf.format(date);
				System.out.println("age:"+(Integer.parseInt(formatDate)-Integer.parseInt(getYear(querryResult))));
				age=(Integer.parseInt(formatDate)-Integer.parseInt(getYear(querryResult)));
			}else{
				System.out.println("No User!");
				return ;
			}
*/
			String UrlIn;
			String QueryIn;
			
			UrlIn="records";
			QueryIn="Select * From records where DATEDIFF(NOW(),datetime)<7 and type='spo2' and value > 0 and uid='" + reading.uid + "'  order by rid desc limit 1";
			Data dataSPO2 = new Data(UrlIn, QueryIn);
			if(dataSPO2.size()>0){
				SPO2=Integer.parseInt(dataSPO2.getRecord(0, "value"));
				System.out.println("SPO2:"+SPO2);
			}else{
				SPO2=-1;
			}
			
			UrlIn="records";
			QueryIn="Select * From records where DATEDIFF(NOW(),datetime)<7 and type='diastolic' and value > 0 and uid='" + reading.uid + "'  order by rid desc limit 1";
			Data dataDia = new Data(UrlIn, QueryIn);
			if(dataDia.size()>0){
				Dia=Integer.parseInt(dataDia.getRecord(0, "value"));
				System.out.println("Dia:"+Dia);
			}else{
				Dia=-1;
			}

			UrlIn="records";
			QueryIn="Select * From records where DATEDIFF(NOW(),datetime)<7 and type='systolic' and value > 0 and uid='" + reading.uid + "'  order by rid desc limit 1";
			Data dataSys = new Data(UrlIn, QueryIn);
			if(dataSys.size()>0){
				Sys=Integer.parseInt(dataSys.getRecord(0, "value"));
				System.out.println("Sys:"+Sys);
			}else{
				Sys=-1;
			}


			UrlIn="users";
			QueryIn="Select * From users where uid='" + reading.uid +"'";
			Data dataSexAge = new Data(UrlIn, QueryIn);
			if(dataSexAge.size()>0){
				sex=dataSexAge.getRecord(0, "gender");
				System.out.println("sex:"+sex);
				//x
				SimpleDateFormat sdf = new SimpleDateFormat("yyyy");
				Date date = new Date();
				String formatDate = sdf.format(date);
				System.out.println("age:"+(Integer.parseInt(formatDate)-Integer.parseInt(getYear1(dataSexAge.getRecord(0, "dob")))));
				age=(Integer.parseInt(formatDate)-Integer.parseInt(getYear1(dataSexAge.getRecord(0, "dob"))));
			}else{
				System.out.println("No User!");
				return ;
			}

			//Compute V1
			String V1="Abnormal";
			if(reading.VF+reading.VT+reading.VP+reading.VS+reading.VW<=6){
				V1="Normal";
			}
			
			//Compute V2
			String V2;
			if(Dia==-1 || Sys==-1){
				V2="NA";
			}else{
					if(sex.equals("m")){
						if(age>=16 && age<=20){RegularSys=115;RegularDia=73;}
						else if(age>=21 && age<=25){RegularSys=115;RegularDia=73;}
						else if(age>=26 && age<=30){RegularSys=115;RegularDia=75;}
						else if(age>=31 && age<=35){RegularSys=117;RegularDia=76;}
						else if(age>=36 && age<=40){RegularSys=120;RegularDia=80;}
						else if(age>=41 && age<=45){RegularSys=124;RegularDia=81;}
						else if(age>=46 && age<=50){RegularSys=128;RegularDia=82;}
						else if(age>=51 && age<=55){RegularSys=134;RegularDia=84;}
						else if(age>=56 && age<=60){RegularSys=137;RegularDia=84;}
						else if(age>=61 && age<=65){RegularSys=148;RegularDia=86;}
					}else{
						if(age>=16 && age<=20){RegularSys=110;RegularDia=70;}
						else if(age>=21 && age<=25){RegularSys=110;RegularDia=71;}
						else if(age>=26 && age<=30){RegularSys=112;RegularDia=73;}
						else if(age>=31 && age<=35){RegularSys=114;RegularDia=74;}
						else if(age>=36 && age<=40){RegularSys=116;RegularDia=77;}
						else if(age>=41 && age<=45){RegularSys=122;RegularDia=78;}
						else if(age>=46 && age<=50){RegularSys=128;RegularDia=79;}
						else if(age>=51 && age<=55){RegularSys=134;RegularDia=80;}
						else if(age>=56 && age<=60){RegularSys=139;RegularDia=82;}
						else if(age>=61 && age<=65){RegularSys=145;RegularDia=83;}			
					}
					if(Dia<=RegularDia+5 && Dia>=RegularDia-5 && Sys<=RegularSys+5 && Sys>=RegularSys-5){
						V2="Normal";
					}else{
						V2="Abnormal";
					}
			}
			//Compute V3
			String V3;
			if(SPO2==-1){
				V3="NA";
			}else{
				if(SPO2>=95 && SPO2 <=100){
					V3="Normal";
				}else{
					V3="Abnormal";
				}
			}

			//Compute V
			//String V;
			reading.V="n";
			if(V1=="Abnormal" || V2=="Abnormal" || V3=="Abnormal"){
				reading.V="a"; 
			}
			System.out.println(reading.V);
        } catch (Exception e) {
            e.printStackTrace();
        }
	}
	
    private static void uploadChiTotal() {
        try {
			alert.putPair("Uid", reading.uid + "");
			alert.putPair("chiTotal", reading.V + "");
			alert.putPair("Date", reading.mDate + "");//			alert.putPair("Date", System.currentTimeMillis() + "");
			alert.putPair("Originator", reading.Originator + "");
			alert.putPair("MessageType", "Reading");
            alert.putPair("Sender", NAME);
            alert.putPair("Purpose","update");
            alert.putPair("Receiver", "ChiUploader");

            alert.putPair("Tongue", reading.VT+"");
            alert.putPair("Fatigue", reading.VW+"");
            alert.putPair("WeakBreadth", reading.VP+"");
            alert.putPair("Pulse", reading.VP+"");
            alert.putPair("Sweaty", reading.VS+"");
            alert.putPair("chiTotal", reading.V);

			encoder.sendMsg(alert);
            alert.removePair("Receiver");
            encoder.sendMsg(alert);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    private static String download(String sqlstr) throws Exception {
		URL url = new URL(sqlstr);
        BufferedReader in = new BufferedReader(
            new InputStreamReader(url.openStream()));
        String inputLine;
        if((inputLine=in.readLine())== null){
            inputLine="";
		}
        in.close();
		return inputLine;
    }
	//x
	private static String getSex(String s)throws Exception{
		int i=0;
		int count=0;
		while(count<7){
			if(s.charAt(i)==',')
				count++;
			i++;
		}
		String newStr="";
		while(s.charAt(i)!=','){
			newStr=newStr+s.charAt(i);
			i++;
		}
		return newStr.trim();
	}
	//x
	private static int getValue(String s)throws Exception{
		int i=0;
		int count=0;
		while(count<5){
			if(s.charAt(i)==',')
				count++;
			i++;
		}
		String newStr="";
		while(s.charAt(i)!=','){
			newStr=newStr+s.charAt(i);
			i++;
		}
		return Integer.parseInt(newStr.trim());
	}

	//x
	private static String getYear(String s)throws Exception{
		int i=0;
		int count=0;
		while(count<8){
			if(s.charAt(i)==',')
				count++;
			i++;
		}
		String newStr="";
		while(s.charAt(i)!='-'){
			newStr=newStr+s.charAt(i);
			i++;
		}
		return newStr.trim();
	}
	//x
	private static String getYear1(String s)throws Exception{
		int i=0;
		String newStr="";
		while(s.charAt(i)!='-'){
			newStr=newStr+s.charAt(i);
			i++;
		}
		return newStr.trim();
	}
}

class MonitorReading {
    // TODO: define your reading input here
	int uid;
	int VT;				//Value of Tongue
	int VF;				//Value of Fatigue
	int VW;				//Value of WeakBreadth
	int VP;				//Value of Pulse
	int VS;				//Value of Sweaty
	String V;			//Total(Normal or Abnormal)
	String Originator;
	Long mDate;
}
